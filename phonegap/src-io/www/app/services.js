angular.module('babywords.services', [])

    // persistence mechanism for words
    // this is not accessed directly by the controller, we interact via the model instead
    .factory("WordsDataService", function () {
        var words = JSON.parse(localStorage["words"] || "[]");
        if (!angular.isArray(words))
            words = [];
        words.forEach(function (w) {
            if (w.when && !angular.isDate(w.when))
                w.when = new Date(Date.parse(w.when));
        });

        function save() {
            localStorage["words"] = JSON.stringify(words);
        }

        return {
            saveWord: function (word) {
                this.removeWord(word);
                words.push(word);
                save();
            },

            removeWord: function (word) {
                words = words.filter(function (w) { return w !== word });
                save();
            },

            // all the words.
            getWords: function () {
                return words;
            }
            //
            //getWord: function(word) {
            //    var result = words.filter(function (w) { return w.word === word });
            //    if(result.length > 0)
            //        return result[0];
            //    return null;
            //}
        }
    })
    .factory("MediaService", function($q) {
        function isTempRecording(src) {
            return /^temp/.test(src);
        }

        // get full URL for the specified file
        // we form the URL according to the file name: temp file go into the cache folder, others go to the data folder.
        function dataPath(src, directoryOnly) {
            return (isTempRecording(src) ?
                    // cacheDirectory not working on android??
                    (cordova.file.externalCacheDirectory || cordova.file.cacheDirectory) :
                    (cordova.file.externalDataDirectory || cordova.file.dataDirectory)) + (directoryOnly ? "" : src);
        }

        function moveFile(sourceFile, destDirectory, destFileName) {
            return new $q(function(resolve, reject) {
                window.resolveLocalFileSystemURL(sourceFile, function(fileEntry) {
                    window.resolveLocalFileSystemURL(destDirectory, function(destDirectoryEntry) {
                        fileEntry.moveTo(destDirectoryEntry, destFileName, function() {
                            resolve(destFileName);
                        }, reject);
                    }, reject);
                }, reject);
            });
        }

        function moveToTempFile(sourceFile) {
            var ext = /\.[^.]*$/.exec(sourceFile)[0];
            var tempFile = "temprecording" + ext;
            var destDirectory = dataPath(tempFile, true);
            return moveFile(sourceFile, destDirectory, tempFile);
        }

        return {
            // capture a video and return path
            startRecording: function () {
                return $q(function (resolve, reject) {
                    if (!navigator.device && navigator.device.capture) {
                        reject("Not available");
                        return;
                    }
                    navigator.device.capture.captureVideo(function (mediaFiles) {
                        // we move the file generated by the system into a temp file so that we can keep overwriting it and not generate a bunch of junk files
                        moveToTempFile(mediaFiles[0].fullPath).then(function (tempFile) {
                            console.log("Resolved to " + tempFile);
                            resolve(tempFile);
                        }, reject);
                    }, function (error) {
                        reject(error);
                    }, {
                        limit: 1
                    });
                });
            },

            // used to save the recording from a temp file to the application data directory.
            saveRecording: function (src) {
                return $q(function (resolve, reject) {
                    if (!isTempRecording(src)) {
                        resolve(src);
                        return;
                    }
                    var m = /\.[^.]*$/.exec(src);
                    if (!m)
                        throw new Error("Unable to get file type " + src);
                    var dest = (new Date()).toISOString().replace(/[^0-9]/g, "") + m[0];
                    var destDirectory = dataPath("destFileName", true);
                    moveFile(dataPath(src), destDirectory, dest).then(function () {
                        resolve(dest);
                    }, reject);
                });
            }
        }
    })
    .factory("NotificationService", function($log) {
        var error = null;
        var notification = null;

        return {
            setError: function(e) {
                $log.warn(e);
                error = e;
            },
            getError: function() {
                return error;
            },
            clearError: function() {
                error = null;
            },
            setNotification: function(n) {
                notification = n;
            },
            getNotification: function() {
                return notification;
            },
            clearNotification: function() {
                notification = null;
            }
        };
    })
    .factory("$exceptionHandler", function ($log) {
        return function (e, cause) {
            var s = "Error in " + (cause || "unspecified") + ": ";
            if (e.message)
                s += e.message;
            if (e.code)
                s += " (code = " + e.code + ")";
            $log.error(s);
        }
    })
    .factory('Chats', function () {
        // Might use a resource here that returns a JSON array

        // Some fake testing data
        var chats = [{
            id: 0,
            name: 'Ben Sparrow',
            lastText: 'You on your way?',
            face: 'https://pbs.twimg.com/profile_images/514549811765211136/9SgAuHeY.png'
        }, {
            id: 1,
            name: 'Max Lynx',
            lastText: 'Hey, it\'s me',
            face: 'https://avatars3.githubusercontent.com/u/11214?v=3&s=460'
        }, {
            id: 2,
            name: 'Andrew Jostlin',
            lastText: 'Did you get the ice cream?',
            face: 'https://pbs.twimg.com/profile_images/491274378181488640/Tti0fFVJ.jpeg'
        }, {
            id: 3,
            name: 'Adam Bradleyson',
            lastText: 'I should buy a boat',
            face: 'https://pbs.twimg.com/profile_images/479090794058379264/84TKj_qa.jpeg'
        }, {
            id: 4,
            name: 'Perry Governor',
            lastText: 'Look at my mukluks!',
            face: 'https://pbs.twimg.com/profile_images/491995398135767040/ie2Z_V6e.jpeg'
        }];

        return {
            all: function () {
                return chats;
            },
            remove: function (chat) {
                chats.splice(chats.indexOf(chat), 1);
            },
            get: function (chatId) {
                for (var i = 0; i < chats.length; i++) {
                    if (chats[i].id === parseInt(chatId)) {
                        return chats[i];
                    }
                }
                return null;
            }
        };
    });
